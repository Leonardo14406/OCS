<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">WhatsApp Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div id="app" class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full text-center">
    <h1 class="text-2xl font-bold mb-4 flex items-center justify-center">
      <svg class="h-6 w-6 text-green-500 mr-2" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 1.89.55 3.64 1.47 5.14L2.2 21.8l4.66-1.22A9.94 9.94 0 0012 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm4.92 13.56c-.29.82-.85 1.48-1.67 1.78-.83.3-1.71.36-2.6.17-.89-.19-1.74-.53-2.54-.99-2.15-1.24-3.53-3.08-3.91-5.36-.14-.82.02-1.65.44-2.36.21-.36.49-.66.84-.88.35-.22.76-.33 1.17-.33.1 0 .2.01.3.03.1.02.2.05.29.09l.83.55c.34.22.63.51.86.86.23.35.34.76.34 1.17 0 .41-.11.82-.34 1.17l-.55.83c-.09.14-.14.3-.14.47 0 .17.05.33.14.47l1.67 1.67c.14.14.3.21.47.21s.33-.07.47-.21l.83-.55c.35-.23.76-.34 1.17-.34.41 0 .82.11 1.17.34.35.23.64.52.86.86.22.34.33.75.33 1.17 0 .41-.11.82-.34 1.17z"/>
      </svg>
      <span id="brand-title">WhatsApp Client</span>
    </h1>
    <div id="qr-container" class="mb-4">
      <p class="text-gray-600 mb-4">Initializing WhatsApp connection...</p>
      <div class="flex justify-center">
        <svg class="animate-spin h-12 w-12 text-blue-500" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    </div>
    <p id="status" class="text-sm text-gray-500">Please wait...</p>
    <button id="refresh-btn" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 hidden" onclick="location.reload()">
      Refresh Page
    </button>
  </div>

  <script>
    const chatbotId = window.location.pathname.split('/').pop();
    const socket = io({ path: '/socket.io' });
    const qrContainer = document.getElementById('qr-container');
    const statusEl = document.getElementById('status');

    // Load brand configuration
    async function loadBrandConfig() {
      try {
        const response = await fetch('/api/brand');
        const brand = await response.json();
        
        // Update page title and brand elements
        document.getElementById('page-title').textContent = `${brand.name} - ${brand.tagline}`;
        document.getElementById('brand-title').textContent = brand.name;
        
        console.log(`Loaded brand: ${brand.name} - ${brand.tagline}`);
      } catch (error) {
        console.warn('Failed to load brand config:', error);
        // Keep default values if brand config fails
      }
    }

    // Load brand configuration on page load
    loadBrandConfig();

    socket.on(`qr:${chatbotId}`, (base64) => {
      console.log('QR code received, displaying image...');
      qrContainer.innerHTML = `
        <p class="text-gray-600 mb-4">Scan this QR code with WhatsApp</p>
        <div class="bg-white p-4 rounded-lg border-2 border-gray-200 inline-block">
          <img src="${base64}" alt="WhatsApp QR Code" class="mx-auto block" style="width: 256px; height: 256px; image-rendering: pixelated;">
        </div>
        <p class="text-xs text-gray-500 mt-2">Point your phone's camera at this QR code</p>
      `;
      statusEl.textContent = 'Waiting for authorization...';
    });

    socket.on(`connected:${chatbotId}`, ({ phoneNumber }) => {
      console.log('Connected:', phoneNumber);
      qrContainer.innerHTML = `
        <svg class="h-12 w-12 text-green-500 mx-auto" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
        </svg>
      `;
      statusEl.textContent = `Connected to ${phoneNumber}`;
    });

    socket.on('connect_error', (error) => {
      console.error('Socket.IO error:', error.message);
      qrContainer.innerHTML = `
        <div class="text-red-500 mb-4">
          <svg class="h-12 w-12 mx-auto mb-2" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <p>Connection failed. Please check your internet connection.</p>
        </div>
      `;
      statusEl.textContent = 'Connection Error';
      document.getElementById('refresh-btn').classList.remove('hidden');
    });

    // Initialize client
    fetch('/init', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatbotId })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'connected') {
          qrContainer.innerHTML = `
            <svg class="h-12 w-12 text-green-500 mx-auto" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
            </svg>
          `;
          statusEl.textContent = `Already connected to ${data.phoneNumber}`;
        } else if (data.status === 'awaiting_qr' && data.qr) {
          qrContainer.innerHTML = `
            <p class="text-gray-600 mb-4">Scan this QR code with WhatsApp</p>
            <div class="bg-white p-4 rounded-lg border-2 border-gray-200 inline-block">
              <img src="${data.qr}" alt="WhatsApp QR Code" class="mx-auto block" style="width: 256px; height: 256px; image-rendering: pixelated;">
            </div>
            <p class="text-xs text-gray-500 mt-2">Point your phone's camera at this QR code</p>
          `;
          statusEl.textContent = 'Waiting for authorization...';
        }
      })
      .catch(error => {
        console.error('Init error:', error);
        qrContainer.innerHTML = `
          <div class="text-red-500 mb-4">
            <svg class="h-12 w-12 mx-auto mb-2" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
            </svg>
            <p>Failed to initialize WhatsApp client.</p>
            <p class="text-sm mt-1">Please try refreshing the page.</p>
          </div>
        `;
        statusEl.textContent = 'Initialization Error';
        document.getElementById('refresh-btn').classList.remove('hidden');
      });
  </script>
</body>
</html>